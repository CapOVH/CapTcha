<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€“ Captcha Finder</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header><!-- same header --></header>

  <main class="container">
    <section class="hero">
      <h2>Welcome, <span id="username"></span>!</h2>
      <button class="btn btn-outline" id="logoutBtn">Logout</button>
    </section>

    <section class="search-section">
      <h3>Quick Scan</h3>
      <div class="search-box">
        <div class="input-group"><i class="fas fa-globe"></i>
          <input type="url" id="quickUrl" placeholder="https://example.com">
        </div>
        <button class="btn btn-primary" id="quickScan">Scan</button>
      </div>
    </section>

    <section class="results" id="quickResult" style="display:none;"></section>

    <section class="search-section">
      <h3>Scan History</h3>
      <div id="history"></div>
    </section>
  </main>

  <script>
    // ---- Auth check ----
    fetch('/api/auth/me')
      .then(r => r.json())
      .then(d => {
        if (!d.username) location.href = '/login.html';
        document.getElementById('username').textContent = d.username;
      });

    document.getElementById('logoutBtn').onclick = () => {
      fetch('/api/auth/logout', { method: 'POST' }).then(() => location.href = '/');
    };

    // ---- Quick scan ----
    document.getElementById('quickScan').onclick = async () => {
      const url = document.getElementById('quickUrl').value.trim();
      if (!url) return alert('Enter a URL');
      const res = await fetch('/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      const container = document.getElementById('quickResult');
      container.style.display = 'block';
      container.innerHTML = renderResults(url, data.captchas);
    };

    // ---- History ----
    async function loadHistory() {
      const res = await fetch('/api/scan/history');
      const scans = await res.json();
      const el = document.getElementById('history');
      if (!scans.length) return el.innerHTML = '<p>No scans yet.</p>';
      el.innerHTML = scans.map(s => `
        <div class="result-item">
          <div><strong>${s.url}</strong><br>
            <small>${new Date(s.scanned_at).toLocaleString()}</small>
          </div>
          <div>${s.result.map(r=>`<span class="result-type">${r.type}</span>`).join(' ')}</div>
        </div>`).join('');
    }
    loadHistory();

    function renderResults(url, captchas) {
      if (!captchas.length) return `<p>No CAPTCHA found on <strong>${url}</strong></p>`;
      return `
        <h4>${captchas.length} CAPTCHA(s) on <strong>${url}</strong></h4>
        ${captchas.map(c=>`
          <div class="result-item">
            <div><strong>${c.type}</strong></div>
            <div class="result-type">${c.confidence}%</div>
          </div>`).join('')}
      `;
    }
  </script>
</body>
</html>
